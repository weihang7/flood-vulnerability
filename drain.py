import csv
import shapefile
import rasterio
import fiona

drain_locations = []
drain_indeces = []

with open('PWD_Inlets.csv', 'rb') as csvfile:
    r = csv.reader(csvfile, delimiter=',')
    for row in r:
        x = row[8]
        y = row[9]
        drain_locations.append((x, y))
    w = shapefile.Writer(shapefile.POINT)
    w.autoBalance = 1

    w.field("DRAIN", "C")
    for d in drain_locations:
        w.point(float(x), float(y))
        w.record(1)
    w.save('drain')

with fiona.open("drain.shp", "r") as shapefile:
    features = [feature["geometry"] for feature in shapefile]

with rasterio.open("3m/cropped.tif") as src:
    out_image, out_transform = rasterio.mask.mask(src, features, crop=True)
    out_meta = src.meta.copy()

out_meta.update({"driver": "GTiff",
                 "height": out_image.shape[1],
                 "width": out_image.shape[2],
                 "transform": out_transform})
with rasterio.open("3m/cropped.tif", "w", **out_meta) as dest:
    dest.write(out_image, indexes=2)
